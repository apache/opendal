; Licensed to the Apache Software Foundation (ASF) under one
; or more contributor license agreements.  See the NOTICE file
; distributed with this work for additional information
; regarding copyright ownership.  The ASF licenses this file
; to you under the Apache License, Version 2.0 (the
; "License"); you may not use this file except in compliance
; with the License.  You may obtain a copy of the License at
;
;   http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing,
; software distributed under the License is distributed on an
; "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
; KIND, either express or implied.  See the License for the
; specific language governing permissions and limitations
; under the License.

(rule
 (targets dllopendal_core.so)
 (deps
  (glob_files *.rs))
 (action
  (progn
   ;; Build Rust cdylib; staticlib exists but is intentionally unused.
   (run sh -c "cd ../../.. && cargo build --release")
   ;; Normalize the Rust-produced shared library name for OCaml dynlink.
   (run sh -c
     "cd ../../.. && cp target/release/libopendal_ocaml.so _build/default/src/dllopendal_core.so 2> /dev/null || cp target/release/libopendal_ocaml.dylib _build/default/src/dllopendal_core.so"))))

(rule
 (targets c_library_flags.sexp)
 (deps dllopendal_core.so)
 (action
  (with-stdout-to
   c_library_flags.sexp
   (run sh -c
    "if [ \"$(uname)\" = \"Darwin\" ]; then echo '(-lpthread -lc -lm -framework CoreFoundation)'; else echo '(-lpthread -lc -lm)'; fi"))))

(library
 (name opendal_core)
 (public_name opendal.opendal_core)
  (c_library_flags
   (:include c_library_flags.sexp)
   -L../../target/release
   -lopendal_ocaml
   -Wl,-rpath,../../target/release))

(install
 (section lib)
 (files dllopendal_core.so))
